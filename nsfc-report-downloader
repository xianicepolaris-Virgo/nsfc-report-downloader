// ==UserScript==
// @name         NSFC_conclusion_downloader_V12_Final
// @namespace    https://blog.rhilip.info/
// @version      12.0_Final
// @description  å›¾ç‰‡å†…å®¹å»é‡ + å¯éšæ—¶åœæ­¢
// @author       ç¼–ç åŠ©æ‰‹
// @match        https://kd.nsfc.gov.cn/finalDetails*
// @match        https://kd.nsfc.cn/finalDetails*
// @require      https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js
// @require      https://unpkg.com/jquery@3.6.0/dist/jquery.js
// @grant        GM_log
// ==/UserScript==

/* globals $, jspdf */

(async function() {
    'use strict';

    // æ³¨å…¥æ ·å¼
    $('head').append(`
        <style>
            #nsfc-panel {
                width: 100%; margin-top: 10px; padding: 15px; border: 2px solid #409eff;
                border-radius: 8px; background: #fff; box-shadow: 0 2px 12px 0 rgba(0,0,0,.1);
            }
            .nsfc-row { display: flex; align-items: center; margin-bottom: 10px; gap: 10px; flex-wrap: wrap; }
            .nsfc-input {
                width: 100px; padding: 5px; border: 1px solid #dcdfe6; border-radius: 4px; text-align: center;
            }
            #nsfc-prog-bg { width: 100%; height: 10px; background: #ebeef5; border-radius: 5px; overflow: hidden; }
            #nsfc-prog-inner { width: 0%; height: 100%; background: #409eff; transition: width 0.3s; }
            #nsfc-log { font-size: 12px; color: #666; margin-top: 8px; line-height: 1.8; }
            .nsfc-btn { padding: 10px 24px; border: none; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: bold; }
            .nsfc-btn-primary { background: #409eff; color: white; }
            .nsfc-btn-danger { background: #f56c6c; color: white; }
            .nsfc-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        </style>
    `);

    // æ„å»º UI
    const panel = $(`
        <div id="nsfc-panel">
            <div class="nsfc-row">
                <span style="font-weight:bold; color:#303133; font-size:16px;">ğŸ“„ ç»“é¢˜æŠ¥å‘Šæ™ºèƒ½ä¸‹è½½</span>
            </div>
            <div class="nsfc-row">
                <label style="font-weight:500;">è¯·æ±‚é—´éš”:</label>
                <input type="number" id="nsfc-delay" class="nsfc-input" value="1200" min="800" max="3000" step="100">
                <span style="font-size:12px; color:#909399;">æ¯«ç§’</span>
            </div>
            <div class="nsfc-row">
                <button id="nsfc-start-btn" class="nsfc-btn nsfc-btn-primary">ğŸš€ å¼€å§‹ä¸‹è½½</button>
                <button id="nsfc-stop-btn" class="nsfc-btn nsfc-btn-danger" style="display:none;">â¹ï¸ åœæ­¢å¹¶ç”ŸæˆPDF</button>
                <span id="nsfc-status" style="font-size:13px; color:#67c23a; font-weight:500;"></span>
            </div>
            <div id="nsfc-prog-bg"><div id="nsfc-prog-inner"></div></div>
            <div id="nsfc-log" style="padding:8px; background:#f5f7fa; border-radius:4px; margin-top:10px;">
                ğŸ’¡ <b>æ™ºèƒ½å»é‡ï¼š</b>æ£€æµ‹åˆ°ä»»ä½•é‡å¤å†…å®¹æ—¶è‡ªåŠ¨åœæ­¢<br>
                ğŸ›‘ <b>éšæ—¶åœæ­¢ï¼š</b>ç‚¹å‡»"åœæ­¢"æŒ‰é’®å¯ä¸­æ–­å¹¶ç«‹å³ç”ŸæˆPDF
            </div>
        </div>
    `);

    let isRunning = false;
    let shouldStop = false;

    // è®¡ç®—å›¾ç‰‡hashå€¼ï¼ˆç”¨äºå†…å®¹å»é‡ï¼‰- ä½¿ç”¨æ–‡ä»¶å¤§å°ä½œä¸ºå¿«é€ŸæŒ‡çº¹
    async function getImageHash(imageUrl) {
        try {
            const res = await fetch(imageUrl);
            const blob = await res.blob();
            const size = blob.size;

            console.log(`å›¾ç‰‡å¤§å°: ${size} bytes, URL: ${imageUrl.substring(0, 80)}...`);

            return size.toString(); // ç›´æ¥ç”¨æ–‡ä»¶å¤§å°ä½œä¸ºhash
        } catch (e) {
            console.error('è®¡ç®—hashå¤±è´¥:', e);
            return null;
        }
    }

    // å¸¦é‡è¯•çš„è¯·æ±‚å‡½æ•°
    async function fetchPageWithRetry(dependUintID, pageIndex, delay, maxRetries = 3) {
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
            if (shouldStop) return { success: false, reason: 'stopped' };

            try {
                const response = await $.post('/api/baseQuery/completeProjectReport', {
                    id: dependUintID,
                    index: pageIndex
                });

                if (response?.code === 200 && response?.data?.url && response.data.url.trim() !== '') {
                    return { success: true, url: response.data.url };
                } else {
                    return { success: false, reason: 'no_data' };
                }
            } catch (e) {
                if (e.status === 503 && attempt < maxRetries) {
                    const waitTime = delay * 2 * attempt;
                    console.log(`ç¬¬ ${pageIndex} é¡µé‡åˆ°503ï¼Œç­‰å¾… ${waitTime}ms åé‡è¯•...`);
                    await new Promise(r => setTimeout(r, waitTime));
                } else if (attempt < maxRetries) {
                    await new Promise(r => setTimeout(r, delay));
                } else {
                    return { success: false, reason: 'failed', error: e };
                }
            }
        }
        return { success: false, reason: 'max_retries' };
    }

    // ç”ŸæˆPDFçš„å‡½æ•°
    async function generatePDF(pages, projectID, projectName) {
        $('#nsfc-log').html(`ğŸ“¦ æ­£åœ¨ç”Ÿæˆ PDF æ–‡ä»¶ï¼Œå…± ${pages.length} é¡µ...`);

        const doc = new jspdf.jsPDF();
        doc.deletePage(1);

        for (let i = 0; i < pages.length; i++) {
            const page = pages[i];
            const progress = 50 + Math.floor(((i + 1) / pages.length) * 50);
            $('#nsfc-prog-inner').css('width', `${progress}%`);
            $('#nsfc-status').text(`ç”ŸæˆPDF: ${i + 1}/${pages.length}`);
            $('#nsfc-log').html(
                `ğŸ“¥ æ­£åœ¨å¤„ç†ç¬¬ ${page.index} é¡µå›¾ç‰‡...<br>` +
                `è¿›åº¦: ${i + 1}/${pages.length} (${Math.round((i + 1) / pages.length * 100)}%)`
            );

            try {
                // é‡æ–°ä¸‹è½½å›¾ç‰‡
                const res = await fetch(page.url);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);

                const blob = await res.blob();
                const img = new Image();
                const objUrl = URL.createObjectURL(blob);
                img.src = objUrl;
                await img.decode();

                doc.addPage([img.width, img.height], img.width < img.height ? 'p' : 'l');
                doc.addImage(img, "PNG", 0, 0, img.width, img.height);

                URL.revokeObjectURL(objUrl);
            } catch (e) {
                console.error(`ç¬¬ ${page.index} é¡µå›¾ç‰‡å¤„ç†å¤±è´¥:`, e);
            }

            await new Promise(r => setTimeout(r, 100));
        }

        $('#nsfc-prog-inner').css('width', '100%');

        try {
            doc.save(`${projectID}_${projectName}.pdf`);
            $('#nsfc-log').html(
                `âœ… <b>ä¸‹è½½å®Œæˆï¼</b><br>` +
                `ğŸ“„ å·²ç”ŸæˆåŒ…å« <b>${pages.length}</b> é¡µçš„å®Œæ•´æŠ¥å‘Š<br>` +
                `<span style="color:#67c23a;">æ–‡ä»¶å·²ä¿å­˜åˆ°ä¸‹è½½æ–‡ä»¶å¤¹</span>`
            );
            $('#nsfc-status').html(`<span style="color:#67c23a;">âœ“ ä¸‹è½½æˆåŠŸ (${pages.length}é¡µ)</span>`);
        } catch (e) {
            $('#nsfc-log').html(`âŒ PDF ç”Ÿæˆå¤±è´¥: ${e.message}`);
        }
    }

    // å¼€å§‹æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    panel.on('click', '#nsfc-start-btn', async function() {
        if (isRunning) return;

        const delay = parseInt($('#nsfc-delay').val());
        if (!delay || delay < 800) {
            alert("è¯·æ±‚é—´éš”ä¸èƒ½å°äº800æ¯«ç§’ï¼");
            return;
        }

        isRunning = true;
        shouldStop = false;

        const startBtn = $('#nsfc-start-btn');
        const stopBtn = $('#nsfc-stop-btn');

        startBtn.hide();
        stopBtn.show();

        const urlParams = new URLSearchParams(location.search);
        const dependUintID = urlParams.get('id');
        const projectID = $('.basic_info div:contains("é¡¹ç›®æ‰¹å‡†å·ï¼š") + div').text().trim() || 'Project';
        const projectName = $('.basic_info div:contains("é¡¹ç›®åç§°ï¼š") + div').text().trim() || 'Report';

        let successPages = [];
        let pageHashes = new Map(); // å­˜å‚¨æ‰€æœ‰é¡µé¢çš„hash: Map<hash, pageIndex>
        let currentPage = 1;
        let consecutiveFailures = 0;
        let foundDuplicate = false;
        const maxConsecutiveFailures = 3;

        $('#nsfc-log').html(`ğŸ“¡ å¼€å§‹æ£€ç´¢æŠ¥å‘Šé¡µé¢...<br>â±ï¸ è¯·æ±‚é—´éš”: ${delay}ms<br>ğŸ” æ™ºèƒ½å»é‡ï¼šæ£€æµ‹åˆ°ä»»ä½•é‡å¤å†…å®¹å³åœæ­¢`);
        $('#nsfc-prog-inner').css('width', '0%');

        // æŒç»­è¯·æ±‚ï¼Œç›´åˆ°é‡åˆ°é‡å¤å†…å®¹æˆ–æ‰‹åŠ¨åœæ­¢
        while (!shouldStop && !foundDuplicate && consecutiveFailures < maxConsecutiveFailures) {
            $('#nsfc-status').text(`æ£€ç´¢ç¬¬ ${currentPage} é¡µ...`);
            $('#nsfc-log').html(
                `ğŸ” æ­£åœ¨æ£€ç´¢ç¬¬ ${currentPage} é¡µ...<br>` +
                `<span style="color:#67c23a;">âœ“ å·²è·å–: ${successPages.length} é¡µ</span><br>` +
                `<span style="color:#909399;">è¿ç»­å¤±è´¥: ${consecutiveFailures}</span>`
            );

            const result = await fetchPageWithRetry(dependUintID, currentPage, delay);

            if (result.success) {
                // è®¡ç®—å›¾ç‰‡å†…å®¹hash
                const hash = await getImageHash(result.url);

                console.log(`ç¬¬ ${currentPage} é¡µ hash: ${hash}`);

                // æ£€æŸ¥è¿™ä¸ªhashæ˜¯å¦å·²ç»å­˜åœ¨
                if (hash && pageHashes.has(hash)) {
                    const duplicatePageIndex = pageHashes.get(hash);
                    foundDuplicate = true;
                    console.log(`!!! ç¬¬ ${currentPage} é¡µæ–‡ä»¶å¤§å° ${hash} ä¸ç¬¬ ${duplicatePageIndex} é¡µç›¸åŒï¼Œæ£€æµ‹åˆ°å¾ªç¯ï¼`);
                    $('#nsfc-log').html(
                        `âœ… <b>ç¬¬ ${currentPage} é¡µä¸ç¬¬ ${duplicatePageIndex} é¡µå†…å®¹ç›¸åŒ (${hash} bytes)</b><br>` +
                        `<span style="color:#67c23a;">æ£€æµ‹åˆ°å¾ªç¯ï¼ŒæŠ¥å‘Šå·²å®Œæ•´ï¼å…± ${successPages.length} é¡µ</span>`
                    );
                    // ç«‹å³è·³å‡ºå¾ªç¯
                    break;
                } else {
                    // æ–°çš„å”¯ä¸€å†…å®¹ï¼Œè®°å½•å¹¶ç»§ç»­
                    if (hash) {
                        pageHashes.set(hash, currentPage);
                    }
                    successPages.push({ index: currentPage, url: result.url });
                    consecutiveFailures = 0;
                    console.log(`âœ“ ç¬¬ ${currentPage} é¡µæˆåŠŸï¼Œæ–‡ä»¶å¤§å°: ${hash} bytes (å”¯ä¸€å†…å®¹)`);
                    $('#nsfc-log').html(
                        `âœ“ ç¬¬ ${currentPage} é¡µæˆåŠŸ (å¤§å°: ${hash} bytes)<br>` +
                        `<span style="color:#67c23a;">å·²è·å–: ${successPages.length} é¡µå”¯ä¸€å†…å®¹</span>`
                    );
                }
            } else {
                if (result.reason !== 'stopped') {
                    consecutiveFailures++;
                    console.log(`âœ— ç¬¬ ${currentPage} é¡µå¤±è´¥ (${result.reason})`);
                }
            }

            currentPage++;

            const estimatedProgress = Math.min((successPages.length / 20) * 50, 50);
            $('#nsfc-prog-inner').css('width', `${estimatedProgress}%`);

            if (!shouldStop && !foundDuplicate) {
                await new Promise(r => setTimeout(r, delay));
            }
        }

        // æ£€æµ‹åœæ­¢åŸå› 
        let stopReason = '';
        if (shouldStop) {
            stopReason = 'ç”¨æˆ·æ‰‹åŠ¨åœæ­¢';
        } else if (foundDuplicate) {
            stopReason = 'æ£€æµ‹åˆ°ä¸ç¬¬1é¡µé‡å¤ï¼ˆæŠ¥å‘Šå®Œæ•´ï¼‰';
        } else if (consecutiveFailures >= maxConsecutiveFailures) {
            stopReason = 'è¿ç»­è¯·æ±‚å¤±è´¥';
        }

        if (successPages.length === 0) {
            $('#nsfc-log').html(
                `âŒ <b>æœªèƒ½è·å–ä»»ä½•é¡µé¢ï¼</b><br>` +
                `åœæ­¢åŸå› : ${stopReason}<br>` +
                `è¯·å°è¯•å¢åŠ è¯·æ±‚é—´éš”æˆ–æ£€æŸ¥ç½‘ç»œè¿æ¥`
            );
            startBtn.show();
            stopBtn.hide();
            isRunning = false;
            return;
        }

        // ç”ŸæˆPDF
        $('#nsfc-log').html(
            `âœ… <b>æ£€ç´¢å®Œæˆï¼</b><br>` +
            `åœæ­¢åŸå› : ${stopReason}<br>` +
            `å…±è·å– ${successPages.length} é¡µä¸é‡å¤å†…å®¹<br>` +
            `ğŸ“¥ å¼€å§‹ç”ŸæˆPDF...`
        );

        await generatePDF(successPages, projectID, projectName);

        startBtn.show().text('ğŸ”„ å†æ¬¡ä¸‹è½½');
        stopBtn.hide();
        isRunning = false;
    });

    // åœæ­¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    panel.on('click', '#nsfc-stop-btn', function() {
        if (!isRunning) return;

        shouldStop = true;
        $('#nsfc-log').html(
            `ğŸ›‘ <b>æ­£åœ¨åœæ­¢...</b><br>` +
            `å°†ä½¿ç”¨å·²è·å–çš„é¡µé¢ç”ŸæˆPDF`
        );
        $(this).prop('disabled', true).text('â³ åœæ­¢ä¸­...');
    });

    // æ’å…¥é¢æ¿
    const observer = new MutationObserver(() => {
        const target = $('div.link_title:has(div:contains("ç»“é¢˜æŠ¥å‘Š"))');
        if (target.length > 0 && $('#nsfc-panel').length === 0) {
            target.after(panel);
        }
    });
    observer.observe(document.body, { childList: true, subtree: true });

})();
